<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>üêé Course de Chevaux</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#0f172a,#020617);
  font-family:system-ui,Arial,sans-serif;
  color:#e5f0ff;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:15px;
}

.card{
  width:100%;
  max-width:420px;
  background:#0b1120;
  border-radius:18px;
  padding:20px;
  border:1px solid #1e3a8a;
  box-shadow:0 10px 40px rgba(0,0,0,.8);
}

h1{
  color:#60a5fa;
  text-align:center;
  margin-bottom:10px;
}

.credit{
  font-size:22px;
  font-weight:800;
  color:#22d3ee;
  margin-bottom:10px;
  text-align:center;
}

input[type=number]{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #1e293b;
  background:#020617;
  color:#bfdbfe;
  font-size:16px;
  text-align:center;
}

button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
  color:white;
  font-weight:800;
  font-size:16px;
}

button:active{transform:scale(.97)}

.msg{
  margin-top:10px;
  min-height:20px;
  text-align:center;
}

/* S√©lection des chevaux */
.pick-container{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  margin-bottom:10px;
}

.pick{
  display:flex;
  align-items:center;
  padding:6px 12px;
  margin:4px;
  border-radius:12px;
  border:1px solid #1e293b;
  background:#020617;
  cursor:pointer;
  flex:1 1 48%;
}

.pick input{margin-right:6px}

/* Course */
.track{margin-top:20px}

.lane{
  position:relative;
  height:36px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  margin-bottom:8px;
  display:flex;
  align-items:center;
}

.lane .name{
  margin-left:6px;
  font-weight:700;
  min-width:60px;
  color:white;
}

.horse{
  position:absolute;
  left:70px;
  height:28px;
  padding:4px 12px;
  border-radius:20px;
  font-weight:700;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.finish{
  position:absolute;
  right:6px;
  top:0;
  bottom:0;
  width:4px;
  background:#22d3ee;
  border-radius:4px;
}
</style>
</head>
<body>

<div class="card">
<h1>üêé Course de Chevaux</h1>
<div class="credit">üí∞ <span id="credits">0</span></div>

<input id="bet" type="number" placeholder="Mise (max 500)" max="500">

<div class="pick-container" id="choices"></div>

<button id="start">Lancer la course</button>
<div class="msg" id="msg"></div>

<div class="track" id="track"></div>
  
  <button id="back" class="secondary">‚¨ÖÔ∏è Retour</button>
  
</div>

  
  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  authDomain: "casino-b23c9.firebaseapp.com",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "casino-b23c9",
  storageBucket: "casino-b23c9.appspot.com",
  messagingSenderId: "139229793155",
  appId: "1:139229793155:web:953b31b383a87bc3c504b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* UTILISATEUR */
const user = localStorage.getItem("casinoUser");
if(!user) location.href="index.html";

/* CHEVAUX */
const pool=[
 {n:"I59R",c:"#facc15"},{n:"Kiko",c:"#facc15"},{n:"S3",c:"#facc15"},
 {n:"1SPI",c:"#22c55e"},{n:"Aikou",c:"#fb923c"},
 {n:"Fanxyz",c:"#7dd3fc"},{n:"Rapport",c:"#22c55e"},
 {n:"Jujux",c:"#1e40af"},{n:"KaxYum",c:"#7dd3fc"},
 {n:"Loorik",c:"#fb923c"},{n:"Vinier",c:"#fb923c"},
 {n:"Chadow",c:"#92400e"},{n:"Yass",c:"#bae6fd"},
 {n:"V3ltrix",c:"#facc15"},{n:"Chanos",c:"#7dd3fc"}
];

let horses=[],credits=0,running=false;

async function loadCredits(){
  const snap=await get(ref(db,"users/"+user));
  credits=snap.val().credits;
  document.getElementById("credits").textContent=credits;
}

function init(){
  horses=pool.sort(()=>Math.random()-0.5).slice(0,5).map(h=>({
    ...h,
    mult:(Math.random()*1.5+1.5).toFixed(2),
    pos:0,
    speed:Math.random()*2+1.5
  }));
  render();
}

function render(){
  const choices=document.getElementById("choices");
  const track=document.getElementById("track");
  choices.innerHTML="";
  track.innerHTML="";

  horses.forEach((h,i)=>{
    // S√©lection
    choices.innerHTML+=`
      <label class="pick">
        <input type="radio" name="pick" value="${i}">
        üêé <span style="color:${h.c}">${h.n} (x${h.mult})</span>
      </label>
    `;
    // Course
    track.innerHTML+=`
      <div class="lane">
        <div class="name">${h.n}</div>
        <div class="horse" id="h${i}" style="background:${h.c};color:#020617">
          üêé
        </div>
        <div class="finish"></div>
      </div>
    `;
  });
}

/* COURSE */
document.getElementById("start").onclick=async()=>{
  if(running) return;
  const betVal=Number(document.getElementById("bet").value);
  const pick=document.querySelector("input[name=pick]:checked");
  if(!pick||betVal<=0||betVal>500) return msg.textContent="Mise invalide (max 500)";
  if(betVal>credits) return msg.textContent="Cr√©dits insuffisants";

  running=true;
  msg.textContent="üèÅ Course lanc√©e";

  // Retirer mise
  await update(ref(db,"users/"+user),{credits:credits-betVal});
  credits-=betVal;
  document.getElementById("credits").textContent=credits;

  const trackEl = document.getElementById("track");
const startOffset = 70; // espace pour le nom
const finishOffset = 6; // correspond √† la barre finish

const interval = setInterval(() => {
  horses.forEach((h, i) => {
    if(!running) return;

    const horseEl = document.getElementById("h"+i);
    const trackWidth = trackEl.clientWidth;
    const maxPos = trackWidth - horseEl.offsetWidth - finishOffset - 30;

    h.pos += Math.random() * h.speed;

    // Limite la position pour que le cheval ne d√©passe pas la ligne
    if(h.pos >= maxPos){
      h.pos = maxPos;
      if(running){ // premier cheval √† atteindre maxPos
        running = false;
        clearInterval(interval);
        finish(i, betVal, pick.value);
      }
    }

    horseEl.style.left = (startOffset + h.pos) + "px";
  });
}, 30);
};

async function finish(win, bet, pick) {
  running = false;
  const h = horses[win];
  const userRef = ref(db, "users/" + user);
  const bankRef = ref(db, "users/Banque Centrale");

  // R√©cup√©rer les cr√©dits de la banque centrale
  const bankSnap = await get(bankRef);
  let bankCredits = bankSnap.exists() ? bankSnap.val().credits : 0;
  let bankBalance = bankSnap.exists() ? (bankSnap.val().balance || 0) : 0;

  if (win == pick) {
    const gain = Math.floor(bet * h.mult);
    credits += gain;
    await update(userRef, { credits });
    msg.textContent = `üéâ ${h.n} gagne ! +${gain} cr√©dits`;
  } else {
    // Perte ‚Üí aller √† la Banque Centrale
    await update(userRef, { credits }); // les cr√©dits ont d√©j√† √©t√© retir√©s au lancement
    await update(bankRef, {
      credits: bankCredits + bet,
      balance: bankBalance + bet
    });
    msg.textContent = `‚ùå ${h.n} gagne. Perdu ${bet} cr√©dits`;
  }

  document.getElementById("credits").textContent = credits;
  setTimeout(init, 3000); // r√©initialise la course
}

await loadCredits();
init();
  
  
  document.getElementById("back").onclick = () => {
  window.location.href = "https://kikoco16.github.io/Casino-Endiorite/"; // ou remplacer par l'URL de la page d'accueil
};
</script>
</body>
</html>
